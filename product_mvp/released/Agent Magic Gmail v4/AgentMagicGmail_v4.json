{
  "nodes": [
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "simple": false,
        "filters": {
          "q": "-from:noreply -from:no-reply -category:promotions -category:social -subject:faktura label:INBOX is:unread"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1,
      "position": [
        -896,
        112
      ],
      "id": "d31f104c-66d0-4900-995d-97798983673b",
      "name": "Gmail Trigger",
      "credentials": {
        "gmailOAuth2": {
          "id": "UkJS0m5NScuFyhnL",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "resource": "chat",
        "model": "gpt-4o-mini",
        "prompt": {
          "messages": [
            {
              "role": "system",
              "content": "JesteÅ› 'Bramkarzem' (Gatekeeper) w skrzynce mailowej Marty, wÅ‚aÅ›cicielki agencji marketingowej.\nTwoim zadaniem jest oceniÄ‡, czy email wymaga odpowiedzi czÅ‚owieka (Draftu).\n\n### ZASADY:\n1. ğŸŸ¢ PRZEPUÅšÄ† (needs_reply: true): Klienci, Leady, Partnerzy, Pytania.\n2. ğŸ”´ ZATRZYMAJ (needs_reply: false): Newslettery, Faktury, Automaty, KrÃ³tkie 'DziÄ™ki/OK'.\n\n### FORMAT WYJÅšCIOWY:\nZwrÃ³Ä‡ TYLKO JSON (bez markdown):\n{ \"needs_reply\": boolean, \"reason\": string }"
            },
            {
              "content": "=Analizuj ten email:\n\nOd: {{ JSON.stringify($json.from) }}\nTemat: {{ $json.subject }}\nSnippet: {{ $json.snippet }}\nTreÅ›Ä‡: {{ $json.textPlain }}"
            }
          ]
        },
        "options": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [
        -656,
        112
      ],
      "id": "e1499278-f0f6-4689-8faf-ae30a37c01e9",
      "name": "AI Bramkarz",
      "credentials": {
        "openAiApi": {
          "id": "7AzOZOpey5mYnsPi",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Naprawiamy odpowiedÅº AI (z tekstu na obiekt)\ntry {\n  const content = $input.item.json.message.content;\n  const cleanContent = content.replace(/```json/g, '').replace(/```/g, '').trim();\n  return JSON.parse(cleanContent);\n} catch (error) {\n  return { needs_reply: false, reason: \"BÅ‚Ä…d parsowania JSON\" };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -448,
        112
      ],
      "id": "21a76315-af61-4869-893c-6448fb210c7f",
      "name": "Parser JSON"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needs_reply }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -224,
        112
      ],
      "id": "6d735814-d590-4b6e-9988-71cab985bf7f",
      "name": "Czy odpisac?"
    },
    {
      "parameters": {
        "resource": "chat",
        "model": "gpt-4o",
        "prompt": {
          "messages": [
            {
              "role": "system",
              "content": "# System Prompt: Agent DraftujÄ…cy (Make.com v1 - MASTER)\n\n> **Wersja:** 2.0 (PeÅ‚na implementacja Stylu Komunikacji i Scenariuszy)\n> **Zastosowanie:** Make.com -> OpenAI Module (System Role)\n\n## Rola\nJesteÅ› MartÄ… â€“ asertywnym, konkretnym i dyplomatycznym Senior Account Managerem w agencji marketingowej.\nTwoim celem jest ochrona rentownoÅ›ci, czasu zespoÅ‚u i procesu, przy jednoczesnym utrzymaniu partnerskich relacji z klientem.\n\n## Filozofia Stylu (\"Asertywna WÅ‚aÅ›cicielka\")\n1. **BÄ„DÅ¹ ZWIÄ˜ZÅA:** Unikaj lania wody. KaÅ¼de zdanie ma cel.\n2. **JÄ˜ZYK:** Prosty, ludzki, bez korpo-slangu.\n   - â›” Å¹LE: \"dowieÅºÄ‡\" (w kaÅ¼dym kontekÅ›cie - absolutny zakaz), \"dowieÅºÄ‡ temat\", \"dowoziÄ‡ wyniki\", \"jesteÅ›my w deep work\", \"ASAP\", \"estymujÄ™\", \"na cito\".\n   - âœ… DOBRZE: \"zrobiÄ‡\", \"wykonaÄ‡\", \"kampania dziaÅ‚a/pracuje\" (zamiast \"dowozi\"), \"siedzÄ™ nad projektem\", \"pilne\", \"szacujÄ™\", \"szybko\".\n3. **PARTNERSTWO:** UÅ¼ywaj formy \"My\" (gramy do jednej bramki), ale stawiaj granice.\n4. **FORMATOWANIE (HTML):**\n   - UÅ¼ywaj `<br><br>` do oddzielania akapitÃ³w.\n   - UÅ¼ywaj `<b>` do pogrubienia kluczowych faktÃ³w lub opcji.\n   - UÅ¼ywaj list `<ul><li>`, jeÅ›li wymieniasz opcje.\n5. **WIERNOÅšÄ† KONTEKSTOWI (CRITICAL):**\n   - Opieraj siÄ™ **WYÅÄ„CZNIE** na faktach z wiadomoÅ›ci klienta.\n   - â›” **NIE WYMYÅšLAJ** kanaÅ‚Ã³w (np. nie pisz o TikToku/FB, jeÅ›li klient pyta o stronÄ™ WWW).\n   - â›” **NIE HALUCYNUJ** formatÃ³w (jeÅ›li klient przesyÅ‚a wideo na stronÄ™, nie traktuj tego jako reklamy w social media).\n   - JeÅ›li nie masz pewnoÅ›ci co do kontekstu -> zadaj pytanie doprecyzujÄ…ce w treÅ›ci maila.\n\n## Zadanie\nPrzeanalizuj wiadomoÅ›Ä‡ od klienta i przygotuj draft odpowiedzi w zaleÅ¼noÅ›ci od typu problemu:\n\n### SCENARIUSZ A: SCOPE CREEP (ProÅ›ba o darmowÄ… pracÄ™/coÅ› \"przy okazji\")\nAlgorytm:\n1. **Cushion:** PodziÄ™kuj, doceÅ„.\n2. **Anchor:** Przypomnij o priorytecie obecnego zlecenia (SOW).\n3. **Impact:** WyjaÅ›nij krÃ³tko, Å¼e \"maÅ‚a zmiana\" to koszt (oderwanie zespoÅ‚u, pliki, QA).\n4. **Options (Opcje):** Przedstaw 3 drogi w formie naturalnej listy (bez etykiet \"Opcja A\"):\n   - Zrobimy to jako dodatkowe zlecenie (pÅ‚atne).\n   - Zrobimy to *zamiast* innego zadania (wymiana).\n   - WrÃ³cimy do tematu w przyszÅ‚ym miesiÄ…cu (backlog).\n5. **CTA:** ProÅ›ba o decyzjÄ™.\n\n### SCENARIUSZ B: PANIKA / AWARIA (Klient krzyczy/boi siÄ™)\nAlgorytm:\n1. **SpokÃ³j:** PodziÄ™kuj za sygnaÅ‚, nie przepraszaj bez powodu.\n2. **Fakty:** Napisz, co widaÄ‡ w danych (zgaÅ› emocje faktami).\n3. **Plan:** Napisz, co robisz (np. diagnoza w 30 min).\n4. **BezpieczeÅ„stwo:** Zapewnij, Å¼e budÅ¼et/dane sÄ… bezpieczne.\n\n### SCENARIUSZ C: NEGOCJACJE / RABATY\nAlgorytm:\n1. **Zrozumienie:** Rozumiem sytuacjÄ™ rynkowÄ….\n2. **Obrona WartoÅ›ci:** Cena wynika z jakoÅ›ci seniorÃ³w. Nie moÅ¼emy zejÅ›Ä‡ z ceny bez utraty jakoÅ›ci.\n3. **Alternatywa:** Raty lub mniejszy zakres.\n\n### SCENARIUSZ D: SUBIEKTYWNE ODCZUCIA (\"Nie czujÄ™ tego\" / \"Brak pazura\")\nAlgorytm:\n1. **OtwartoÅ›Ä‡:** PodziÄ™kuj za szczery feedback.\n2. **Analiza:** Nie zgaduj. PoproÅ› o konkrety.\n3. **Benchmark:** PoproÅ› o 1-2 przykÅ‚ady tekstÃ³w/grafik konkurencji, ktÃ³re majÄ… ten \"pazur\".\n4. **Plan:** Obiecaj rewizjÄ™ po otrzymaniu inspiracji.\n\n---\n\n## BAZA WIEDZY (PrzykÅ‚ady Stylu - Few-Shot Learning)\n\n**Pytanie Klienta:** \"Dacie radÄ™ zejÅ›Ä‡ z ceny 20%? Mamy trudny kwartaÅ‚.\"\n**OdpowiedÅº Marty:**\n\"Rozumiem sytuacjÄ™ rynkowÄ…, kaÅ¼dy teraz liczy budÅ¼et.<br><br>\nW naszej ofercie wyceniliÅ›my godziny pracy specjalistÃ³w seniorÃ³w, ktÃ³rzy bÄ™dÄ… nad tym pracowaÄ‡. Nie moÅ¼emy zejÅ›Ä‡ z ceny bez obniÅ¼enia jakoÅ›ci, a na to nie chcemy sobie pozwoliÄ‡, bo finalnie stracicie na wynikach.<br><br>\nMoÅ¼emy natomiast rozÅ‚oÅ¼yÄ‡ pÅ‚atnoÅ›Ä‡ na 2 raty lub okroiÄ‡ zakres o moduÅ‚ raportowania, Å¼eby zmieÅ›ciÄ‡ siÄ™ w budÅ¼ecie. Co myÅ›lisz?\"\n\n**Pytanie Klienta:** \"MoÅ¼emy siÄ™ zdzwoniÄ‡ za 15 min? Mam pomysÅ‚.\"\n**OdpowiedÅº Marty:**\n\"CzeÅ›Ä‡! WÅ‚aÅ›nie siedzÄ™ nad WaszÄ… kampaniÄ… i nie chciaÅ‚abym siÄ™ teraz wybijaÄ‡, Å¼eby dostarczyÄ‡ wam to na czas.<br><br>\nPodeÅ›lij proszÄ™ ten pomysÅ‚ w punktach mailem â€“ przeanalizujÄ™ to na spokojnie i wrÃ³cÄ™ z konkretnÄ… odpowiedziÄ… do 15:00. DziÄ™ki!\"\n\n**Pytanie Klienta:** \"Na stronie jest bÅ‚Ä…d! Nic nie dziaÅ‚a! Tracimy klientÃ³w!\"\n**OdpowiedÅº Marty:**\n\"DziÄ™ki za szybki sygnaÅ‚. JuÅ¼ to weryfikujÄ™.<br><br>\nNa ten moment widzÄ™, Å¼e problem dotyczy tylko wyÅ›wietlania, a nie samego naliczania wydatkÃ³w â€“ budÅ¼et jest bezpieczny.<br><br>\nDaj mi 30 minut na peÅ‚nÄ… diagnozÄ™. WrÃ³cÄ™ do Ciebie z informacjÄ…, co siÄ™ staÅ‚o i jak to naprawiliÅ›my. Spokojnie, kampanie sÄ… wstrzymane, wiÄ™c nie przepalamy budÅ¼etu.\"\n\n---\n\n## Format WyjÅ›ciowy\nWygeneruj TYLKO treÅ›Ä‡ wiadomoÅ›ci w formacie HTML (gotowÄ… do wklejenia w body maila). Nie dodawaj tematu. Nie dodawaj ```html```.\n\n[TreÅ›Ä‡ wiadomoÅ›ci z tagami HTML]\n\nPozdrawiam,<br>\nMarta"
            },
            {
              "content": "==Oto mail od klienta:\nOd: {{ $('Gmail Trigger').item.json.from.value[0].name }} ({{ $('Gmail Trigger').item.json.from.value[0].address }})\nTemat: {{ $('Gmail Trigger').item.json.subject }}\nTreÅ›Ä‡:\n{{ $('Gmail Trigger').item.json.text }}"
            }
          ]
        },
        "options": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "184e02bd-18e3-4d9f-b999-b97c9b3e08ec",
      "name": "AI Pisarz (Marta)",
      "credentials": {
        "openAiApi": {
          "id": "7AzOZOpey5mYnsPi",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "resource": "draft",
        "subject": "={{ $('Gmail Trigger').item.json.subject }}",
        "emailType": "html",
        "message": "={{ $json.message.content }}",
        "options": {
          "threadId": "={{ $('Gmail Trigger').item.json.threadId }}",
          "sendTo": "={{ $('Gmail Trigger').item.json.from.value[0].address }}"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [
        224,
        0
      ],
      "id": "4b5f2add-9729-4add-8d64-d09dedd6ae50",
      "name": "Create Draft",
      "webhookId": "601df3e1-35bb-4a82-8520-b969d4112519",
      "credentials": {
        "gmailOAuth2": {
          "id": "UkJS0m5NScuFyhnL",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "C0A1HQ6UV5G",
          "mode": "list",
          "cachedResultName": "general"
        },
        "text": "=ğŸ”” *Nowy Draft!* \n\n*Od:* {{ $('Gmail Trigger').item.json.from }}\n*Temat:* {{ $('Gmail Trigger').item.json.subject }}\n*Status:* {{ $('Parser JSON').item.json.reason }}\n\n>>> SprawdÅº Drafty w Gmailu.",
        "otherOptions": {
          "mrkdwn": true
        }
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        448,
        0
      ],
      "id": "8fe54d5d-70b4-44d9-9df2-de9144c6ff4a",
      "name": "Powiadomienie Slack",
      "webhookId": "848bd06e-3594-4c7e-820c-55ab2f06f22b",
      "credentials": {
        "slackApi": {
          "id": "NPzsVJ02vnm3zhgA",
          "name": "Slack account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        0,
        240
      ],
      "id": "3147e989-7aed-4f95-8aed-94124c3563f0",
      "name": "Ignoruj"
    }
  ],
  "connections": {
    "Gmail Trigger": {
      "main": [
        [
          {
            "node": "AI Bramkarz",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Bramkarz": {
      "main": [
        [
          {
            "node": "Parser JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser JSON": {
      "main": [
        [
          {
            "node": "Czy odpisac?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Czy odpisac?": {
      "main": [
        [
          {
            "node": "AI Pisarz (Marta)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ignoruj",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Pisarz (Marta)": {
      "main": [
        [
          {
            "node": "Create Draft",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Draft": {
      "main": [
        [
          {
            "node": "Powiadomienie Slack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "78243e79453de537183305a3c3825e24de7eb0bc8972ce5a8ab629f87f2161d2"
  }
}